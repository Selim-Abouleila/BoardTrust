<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>📦 Louer un jeu – BoardTrust</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top{height:180px;object-fit:cover}
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="text-center mb-4">📦 Louer un jeu</h1>
    <div id="gamesList" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4"></div>
</div>

<script type="module">
    /*───────────────────────────────────────────────────────────
    |  CONFIG & HELPERS
    └──────────────────────────────────────────────────────────*/
    const API = 'https://boardtrust-production.up.railway.app';     // ← change only if backend moves

    async function jFetch (url, opts={}) {
        const res  = await fetch(url, { credentials:'include', ...opts });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
        return data;
    }

    /*───────────────────────────────────────────────────────────
    |  WHO IS LOGGED IN ?
    └──────────────────────────────────────────────────────────*/
    const me = await jFetch(`${API}/me`);
    if (!me.loggedIn) {
        alert('Veuillez vous connecter.');
        location.href = '/login.html';
        throw new Error('Not authenticated');
    }
    const uid = me.id_utilisateur;

    /*───────────────────────────────────────────────────────────
    |  MAIN RENDERING
    └──────────────────────────────────────────────────────────*/
    async function loadGames () {
        const games = await jFetch(`${API}/games`);

        /* ask /isRented for each game in parallel */
        const gamesWithFlag = await Promise.all(
            games.map(async g => {
                const { rented } = await jFetch(`${API}/isRented`, {
                    method :'POST',
                    headers : { 'Content-Type':'application/json' },
                    body : JSON.stringify({ id_utilisateur: uid, id_jeu: g.id_jeu })
                });
                return { ...g, rentedByMe: rented };
            })
        );

        render(gamesWithFlag);
    }

    function render (games) {
        const wrap = document.getElementById('gamesList');
        wrap.innerHTML = '';

        for (const g of games) {
            const col = document.createElement('div');
            col.className = 'col';

            col.innerHTML = `
      <div class="card h-100 shadow-sm">
        <img src="${g.imageUrl || 'default-image.png'}" alt="${g.nom}" class="card-img-top">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${g.nom}</h5>
          <p class="small mb-1"><strong>Année :</strong> ${g.annee_publication ?? 'N/A'}</p>
          <p class="small mb-1"><strong>Moyenne :</strong> ${g.average ?? 'N/A'}</p>
          <p class="small mb-3"><strong>Utilisateurs :</strong> ${g.nb_users ?? 'N/A'}</p>

          <div class="mt-auto">
            ${g.rentedByMe
                ? `<button class="btn btn-danger w-100" data-id="${g.id_jeu}" data-action="return">Retourner</button>`
                : `<button class="btn btn-primary w-100" data-id="${g.id_jeu}" data-action="rent">Louer</button>`
            }
          </div>
        </div>
      </div>`;
            wrap.appendChild(col);
        }
    }

    /*───────────────────────────────────────────────────────────
    |  BUTTON HANDLER
    └──────────────────────────────────────────────────────────*/
    document.getElementById('gamesList').addEventListener('click', async ev => {
        const btn = ev.target.closest('button[data-action]');
        if (!btn) return;

        const id_jeu = Number(btn.dataset.id);
        const action = btn.dataset.action;

        try {
            if (action === 'rent') {
                const date = prompt('Date de retour prévue (AAAA-MM-JJ):');
                if (!date) return;

                await jFetch(`${API}/rent`, {
                    method :'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify({ id_jeu, date_retour_prevue: date })
                });
            }

            if (action === 'return') {
                if (!confirm('Confirmer le retour du jeu ?')) return;
                await jFetch(`${API}/return`, {
                    method :'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify({ id_jeu })
                });
            }

            await loadGames();          // refresh buttons
        } catch (e) {
            console.error(e); alert(e.message);
        }
    });

    /* kickoff */
    loadGames();
</script>
</body>
</html>
