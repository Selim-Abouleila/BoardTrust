<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Louer un jeu - BoardTrust</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        header img {
            width: 120px;
            height: auto;
            cursor: pointer;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #games-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            max-width: 1000px;
        }
        .game-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .game-card h2 {
            margin: 0 0 10px;
            font-size: 1.2rem;
            color: #222;
        }
        .game-details {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }
        .game-details div {
            margin: 4px 0;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .controls input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .controls button {
            padding: 10px;
            border: none;
            background: #e63946;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .controls button:disabled {
            background: #ccc;
            cursor: default;
        }
    </style>
</head>
<body>
<header>
    <a href="main.html">
        <img src="/assets/logo.png" alt="BoardTrust">
    </a>
</header>
<h1>Louer un jeu</h1>
<div id="games-container">Chargement des jeux...</div>

<script>
    // Récupère la liste des jeux disponibles
    async function fetchGames() {
        try {
            const res = await fetch('/games', { credentials: 'include' });
            if (!res.ok) throw new Error('Erreur lors de la récupération des jeux');
            const games = await res.json();
            renderGames(games);
        } catch (err) {
            document.getElementById('games-container').innerText = err.message;
        }
    }

    // Affiche les cartes de jeux
    function renderGames(games) {
        const container = document.getElementById('games-container');
        container.innerHTML = '';
        if (!Array.isArray(games) || games.length === 0) {
            container.innerText = 'Aucun jeu disponible à la location.';
            return;
        }

        games.forEach(game => {
            const card = document.createElement('div');
            card.className = 'game-card';

            // Titre du jeu
            const title = document.createElement('h2');
            title.innerText = game.nom || 'Jeu sans nom';
            card.appendChild(title);

            // Détails du jeu
            const details = document.createElement('div');
            details.className = 'game-details';
            details.innerHTML = `
                    <div><strong>ID :</strong> ${game.id_jeu}</div>
                    <div><strong>Année de publication :</strong> ${game.annee_publication || 'N/A'}</div>
                    <div><strong>Note moyenne :</strong> ${game.average ?? 'N/A'}</div>
                    <div><strong>Note bayésienne :</strong> ${game.bayes_average ?? 'N/A'}</div>
                    <div><strong>Nombre d'utilisateurs :</strong> ${game.nb_users ?? 'N/A'}</div>
                `;
            card.appendChild(details);

            // Contrôles de location
            const controls = document.createElement('div');
            controls.className = 'controls';

            // Date de retour prévue
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.value = today;
            controls.appendChild(dateInput);

            // Bouton Louer
            const rentBtn = document.createElement('button');
            rentBtn.innerText = 'Louer';
            rentBtn.onclick = () => rentGame(game.id_jeu, dateInput.value, rentBtn);
            controls.appendChild(rentBtn);

            card.appendChild(controls);
            container.appendChild(card);
        });
    }

    // Envoie la requête de location
    async function rentGame(id_jeu, date_retour_prevue, button) {
        if (!date_retour_prevue) {
            alert('Veuillez choisir une date de retour.');
            return;
        }
        button.disabled = true;
        button.innerText = 'En cours...';

        try {
            const res = await fetch('/rent', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_jeu, date_retour_prevue })
            });

            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'Erreur lors de la location');

            alert('Jeu loué avec succès !');
            button.innerText = 'Loué';
            button.disabled = true;
        } catch (err) {
            alert('Erreur : ' + err.message);
            console.error(err);
            button.disabled = false;
            button.innerText = 'Louer';
        }
    }

    document.addEventListener('DOMContentLoaded', fetchGames);
</script>
</body>
</html>
