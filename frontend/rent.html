<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Louer un jeu - BoardTrust</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #f4f7f6; /* A light background color */
            font-family: Arial, sans-serif;
        }
        .container {
            /* Adding a bit of padding and centering */
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card {
            min-width: 300px;
            margin-bottom: 20px;
        }
        .card-title {
            white-space: normal;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4 text-center">ðŸ“¦ Louer un jeu</h2>
    <div id="gamesList" class="row g-4"></div>
</div>

<script>
    // Hard-coding the logged-in user ID for demonstration purposes.
    const loggedUserId = 1;

    /**
     * Calls the backend to check if a game is currently rented by the specified user.
     * Expects the endpoint /isRented to return JSON: { rented: true } or { rented: false }
     */
    async function isGameRentedByUser(id_jeu, id_utilisateur) {
        try {
            const res = await fetch('https://boardtrust-production.up.railway.app/isRented', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_utilisateur, id_jeu })
            });
            const data = await res.json();
            console.log(`Game ${id_jeu} rented status for user ${id_utilisateur}:`, data);
            return data.rented;
        } catch (error) {
            console.error('Error checking rental status:', error);
            return false; // Default to false in case of error.
        }
    }

    /**
     * Loads the list of games.
     * For each game, checks whether the logged-in user is renting it using isGameRentedByUser().
     * Displays:
     *   - A "Retourner" button if the logged-in user is renting the game.
     *   - A disabled "Indisponible" button if the game is rented by someone else.
     *   - A "Louer" button if the game is available.
     */
    async function loadGames() {
        try {
            const res = await fetch('https://boardtrust-production.up.railway.app/games');
            const games = await res.json();
            const container = document.getElementById('gamesList');
            container.innerHTML = ''; // Clear previous content

            for (const game of games) {
                // Check if the logged-in user is renting this game.
                const userRented = await isGameRentedByUser(game.id_jeu, loggedUserId);
                let actionButton = '';

                if (userRented) {
                    // If the logged-in user already rented the game, show a "Retourner" button.
                    actionButton = `<button class="btn btn-danger" onclick="returnGame(${game.id_jeu}, ${loggedUserId})">Retourner</button>`;
                } else {
                    // If not, check whether the game is rented by someone else.
                    if (game.isRented) {
                        actionButton = `<button class="btn btn-secondary" disabled>Indisponible</button>`;
                    } else {
                        actionButton = `<button class="btn btn-primary" onclick="rentGame(${game.id_jeu})">Louer</button>`;
                    }
                }

                // Build the card for each game.
                const card = document.createElement('div');
                card.className = 'col-lg-4 col-md-6 col-sm-12';
                card.innerHTML = `
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">${game.nom}</h5>
                <p><strong>AnnÃ©e de publication:</strong> ${game.annee_publication || 'N/A'}</p>
                <p><strong>Moyenne:</strong> ${game.average || 'N/A'}</p>
                <p><strong>Bayes Moyenne:</strong> ${game.bayes_average || 'N/A'}</p>
                <p><strong>Nombre d'utilisateurs:</strong> ${game.nb_users || 'N/A'}</p>
                <div class="d-grid gap-2">
                  ${actionButton}
                </div>
              </div>
            </div>
          `;
                container.appendChild(card);
            }
        } catch (error) {
            console.error('Erreur de chargement des jeux:', error);
        }
    }

    /**
     * Sends a rental request for the specified game.
     */
    async function rentGame(id_jeu) {
        const date_retour = prompt("Date de retour prÃ©vue (AAAA-MM-JJ):");
        try {
            const res = await fetch('https://boardtrust-production.up.railway.app/rent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_utilisateur: loggedUserId, id_jeu, date_retour_prevue: date_retour })
            });
            const data = await res.json();
            alert(data.message || data.error);
            loadGames(); // Refresh to update the state
        } catch (error) {
            console.error('Erreur lors de la location du jeu:', error);
        }
    }

    /**
     * Sends a return request for the specified game.
     */
    async function returnGame(id_jeu, id_utilisateur) {
        try {
            const res = await fetch('https://boardtrust-production.up.railway.app/return', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_utilisateur, id_jeu })
            });
            const data = await res.json();
            alert(data.message || data.error);
            loadGames(); // Refresh to update the state
        } catch (error) {
            console.error('Erreur lors du retour du jeu:', error);
        }
    }

    // Load games on page load.
    loadGames();
</script>
</body>
</html>
