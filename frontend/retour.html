<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Retourner un jeu - BoardTrust</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f7f6;
      font-family: Arial, sans-serif;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    .card {
      margin-bottom: 20px;
      min-width: 300px;
    }
    .card-title {
      white-space: normal;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="mb-4 text-center">ðŸ”„ Retourner un jeu</h2>
  <div id="rentedGamesList" class="row g-4"></div>
</div>

<script>
  // For demonstration, the logged-in user ID is hard-coded.
  // In your production environment, this should come from your session logic.
  const loggedUserId = 1;

  /**
   * Loads all games and then filters them to display only those
   * that are currently rented by the logged-in user.
   */
  async function loadRentedGames() {
    try {
      // Adjust the URL as needed (localhost vs production).
      const gamesResponse = await fetch('http://localhost:3000/games', { credentials: 'include' });
      if (!gamesResponse.ok) {
        throw new Error(`HTTP error ${gamesResponse.status} fetching games`);
      }
      const games = await gamesResponse.json();
      const container = document.getElementById('rentedGamesList');
      container.innerHTML = ''; // Clear any previous content.

      // Loop through all games and check if the logged-in user is renting them.
      for (const game of games) {
        // Send a POST to /isRented with id_utilisateur and id_jeu.
        const isRentedResponse = await fetch('http://localhost:3000/isRented', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ id_utilisateur: loggedUserId, id_jeu: game.id_jeu })
        });
        const { rented } = await isRentedResponse.json();

        // Only display the game if rented is true.
        if (rented) {
          const col = document.createElement('div');
          col.className = 'col-lg-4 col-md-6 col-sm-12';
          col.innerHTML = `
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">${game.nom}</h5>
                  <p><strong>AnnÃ©e de publication:</strong> ${game.annee_publication || 'N/A'}</p>
                  <p><strong>Moyenne:</strong> ${game.average || 'N/A'}</p>
                  <p><strong>Bayes Moyenne:</strong> ${game.bayes_average || 'N/A'}</p>
                  <p><strong>Nombre d'utilisateurs:</strong> ${game.nb_users || 'N/A'}</p>
                  <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="returnGame(${game.id_jeu})">Retourner ce jeu</button>
                  </div>
                </div>
              </div>`;
          container.appendChild(col);
        }
      }
    } catch (error) {
      console.error('Error loading rented games:', error);
      alert('Erreur lors du chargement des jeux');
    }
  }

  /**
   * Sends a request to return a game.
   * It calls the /return endpoint with the id_jeu.
   */
  async function returnGame(id_jeu) {
    try {
      const returnResponse = await fetch('http://localhost:3000/return', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ id_jeu })
      });
      const result = await returnResponse.json();
      if (returnResponse.ok) {
        alert(result.message || 'Jeu retournÃ© avec succÃ¨s');
      } else {
        alert(result.error || 'Erreur lors du retour du jeu');
      }
      // Reload the rented games list after return.
      loadRentedGames();
    } catch (error) {
      console.error('Error returning game:', error);
      alert('Erreur lors du retour du jeu');
    }
  }

  // Load the rented games when the page loads.
  loadRentedGames();
</script>
</body>
</html>
